FROM rust:slim-bullseye as builder
WORKDIR /usr/src/livectf

RUN apt-get update \
    && apt-get install -y pkg-config libssl-dev libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Capture dependencies
COPY infrastructure/Cargo.toml infrastructure/Cargo.lock ./

RUN cargo new --lib common
COPY infrastructure/common/Cargo.toml common/

RUN cargo new --lib challenge-api
COPY infrastructure/challenge-api/Cargo.toml challenge-api/

RUN cargo new --lib dashboard
COPY infrastructure/dashboard/Cargo.toml dashboard/

RUN cargo new --lib score-reporter
COPY infrastructure/score-reporter/Cargo.toml score-reporter/

RUN cargo new --lib exploit-runner
COPY infrastructure/exploit-runner/Cargo.toml exploit-runner/

RUN cargo new --lib exploit-builder
COPY infrastructure/exploit-builder/Cargo.toml exploit-builder/

RUN --mount=type=cache,target=/usr/local/cargo/registry \
    cargo build -p exploit-builder --release

COPY infrastructure/ .
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    touch challenge-api/src/main.rs \
        exploit-builder/src/main.rs \
        exploit-builder/src/lib.rs \
        exploit-runner/src/main.rs \
        exploit-runner/src/lib.rs \
        common/src/lib.rs && \
        cargo build -p exploit-builder --release


FROM debian:bullseye-slim
RUN apt-get update && apt-get install -y libpq5 ca-certificates curl gnupg lsb-release

RUN mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
    $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

RUN apt-get update \ 
    && apt-get install -y fuse-overlayfs podman docker-ce-cli \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /usr/src/livectf/target/release/exploit-builder /usr/local/bin/exploit-builder
RUN mkdir -p /tmp/builds

RUN useradd podman -m -u 1000; echo podman:10000:5000 > /etc/subuid; echo podman:10000:5000 > /etc/subgid;
#VOLUME /var/lib/containers
#VOLUME /home/podman/.local/share/containers
COPY deploy/docker/containers.conf /etc/containers/containers.conf
COPY deploy/docker/storage.conf /etc/containers/storage.conf
COPY deploy/docker/podman-containers.conf /etc/containers/podman-containers.conf
RUN mkdir -p /var/lib/shared/overlay-images /var/lib/shared/overlay-layers /var/lib/shared/vfs-images /var/lib/shared/vfs-layers; touch /var/lib/shared/overlay-images/images.lock; touch /var/lib/shared/overlay-layers/layers.lock; touch /var/lib/shared/vfs-images/images.lock; touch /var/lib/shared/vfs-layers/layers.lock
ENV _CONTAINERS_USERNS_CONFIGURED=""

CMD ["exploit-builder"]
